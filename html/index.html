<html>

<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Portal Gun 2.0</title>
<link rel="stylesheet" type="text/css" href="portalstyle.css">
</head>

<body id="index-page">

<table>
<tr>
<td><input type="button" class="button" id="currentgun" onclick="navto(this)" value=""/></td>
<td><div id="connectedstate">Loading...</div></td>
<td><input type="button" class="button" id="othergun" onclick="navto(this)" value=""/></td>
</tr>
</table>

<table>
<tr>
<td><input type="button" class="button" id="mode_button" onclick="mode(this)" value="Settings"/></td>
</tr>
</table>

<input type="button" class="button" id="orangewifi" value="0" onclick="submitb(this.id)"/>
<input type="button" class="button" id="orangeself" value="0" onclick="submitb(this.id)"/>
<input type="button" class="button" id="close" value="Close" onclick="submitb(this.id)"/>
<input type="button" class="button" id="blueself" value="0" onclick="submitb(this.id)"/>
<input type="button" class="button" id="bluewifi" value="0" onclick="submitb(this.id)"/>

<br>

<div id="imageWrapper"> 
<img class="overlayImage1" id="portal_background" src="black.png">
<img class="overlayImage2" id="portal_foreground" src="black.png">
<div class="overlayText" id="portal_text">Loading...</div>
</div>

<div id="playlistdiv"> 



<table>
<tr>
<td valign="top"><div id="sharedplaylist"></div></td>
<td valign="top"><div id="selfplaylist"></div></td>
</tr>
</table>
</div>

<div id="settingsdiv"> 

self things
<input type="button" id="libvisual" onclick="submit(this)" value="vis"/>
<input type="button" id="movieclip" onclick="submit(this)" value="clips"/>
<input type="button" id="moviemusic" onclick="submit(this)" value="music"/>
<br>
<button type="button" id="ir0" onclick="submit(this)">IR OFF</button>
<button type="button" id="ir127" onclick="submit(this)">IR HALF</button>
<button type="button" id="ir255" onclick="submit(this)">IR ON</button>

</div>

<script src="jquery-2.2.0.min.js"></script>

</body>
<script>
var requested_mode = "preview";
var connected_last = -1;
var shared_state = -1;
var shared_state_last = -1;
var private_state = -1;
var private_state_last = -1;

var private_effect_last = -1;
var private_playlist_index_last = -1;
var shared_effect_last = -1;
var shared_playlist_index_last = -1;

var private_playlist = [0,0,0,0,0,0,0,0,0,0];
var shared_playlist = [0,0,0,0,0,0,0,0,0,0];

var private_effect_text = "";
var shared_effect_text = "";

function navto(button) {
	if (button.value == "Gordon"){
		window.location.href = 'http://192.168.1.22';
	}
	else if (button.value == "Chell"){
		window.location.href = 'http://192.168.1.23';
	}
}

function mode(button){
	if (requested_mode == "preview"){
		requested_mode = "settings";
		mode_button.value = "Preview";
	}
	else if (requested_mode == "settings"){
		requested_mode = "preview"
		mode_button.value = "Settings";
	}
	mode_set();
}

function mode_set(){

	if (requested_mode == "preview"){
		if (private_state == 0 && shared_state == 0){ 
			settingsdiv.style.visibility = 'hidden';  
			imageWrapper.style.visibility = 'hidden'; 
			playlistdiv.style.visibility = 'visible'; 
		}else{
			settingsdiv.style.visibility = 'hidden';  
			imageWrapper.style.visibility = 'visible'; 
			playlistdiv.style.visibility = 'hidden'; 
		}
	}
	else if (requested_mode == "settings"){
		settingsdiv.style.visibility = 'visible';  
		imageWrapper.style.visibility = 'hidden'; 
		playlistdiv.style.visibility = 'hidden'; 		
	}

}
function submitb(button) {
	requested_mode = "preview";
	mode_set();
	
	switch(button) {
	case "orangewifi":
		var changeto = 100;
		break;
	case "orangeself":
		var changeto = 101;
		break;
	case "blueself":
		var changeto = 103;
		break;
	case "bluewifi":
		var changeto = 104;
		break;
	default:
		var changeto = 102;
	} 
	$.post('index_post.php', {mode: 1,changeto: changeto});
}


function submit(button) {

	if (button.id == 'libvisual'){
		var mode = 3;
		var changeto = "10 13 14 15 -1 -1 -1 -1 -1 -1";
	}
	if (button.id == 'movieclip'){
		var mode = 3;
		var changeto = "50 51 52 53 54 55 56 57 58 59";
	}
	if (button.id == 'moviemusic'){
		var mode = 3;
		var changeto = "60 61 -1 -1 -1 -1 -1 -1 -1 -1";
	}		
	if (button.id == 'ir0'){
		var mode = 2;
		var changeto = 0;
	}
	if (button.id == 'ir127'){
		var mode = 2;
		var changeto = 127;
	}
	if (button.id == 'ir255'){
		var mode = 2;
		var changeto = 255;
	}

	
	$.post('index_post.php', {
mode: mode,
changeto: changeto
	});
}

function effect_name(a) {
	switch(a) {
	case 0:		return "BLANK";
	case 1:		return "TEST";
	case 2:		return "TEST_CUBE";	
	case 3:		return "RPICAMSRC";	
	case 4:		return "NORMAL";
	case 10:	return "JESS";
	case 11:	return "INFINITE";
	case 12:	return "JACKDAW";
	case 13:	return "OINKSIE";
	case 14:	return "GOOM";
	case 15:	return "GOOM2K1";
	case 20:	return "REV";
	case 21:	return "AGING";
	case 22:	return "DICE";
	case 23:	return "WARP";
	case 24:	return "SHAGADELIC";
	case 25:	return "VERTIGO";
	case 26:	return "KALEIDOSCOPE";
	case 27:	return "MARBLE";		
	case 28:	return "RIPPLE";
	case 29:	return "EDGE";	
	case 30:	return "GL_CUBE";
	case 31:	return "GL_MIRROR";
	case 32:	return "GL_SQUEEZE";
	case 33:	return "GL_STRETCH";
	case 34:	return "GL_TUNNEL";
	case 35:	return "GL_TWIRL";
	case 36:	return "GL_BULDGE";
	case 37:	return "GLHEAT";		
	case 50:	return "MOVIE1";
	case 51:	return "MOVIE2";
	case 52:	return "MOVIE3";
	case 53:	return "MOVIE4";
	case 54:	return "MOVIE5";
	case 55:	return "MOVIE6";
	case 56:	return "MOVIE7";
	case 57:	return "MOVIE8";		
	case 58:	return "MOVIE9";
	case 59:	return "MOVIE10";
	case 60:	return "MOVIE11";
	case 61:	return "MOVIE12";	
	default:	return "UKNOWN";
	}
}

$(document).ready(function () {

	settingsdiv.style.visibility = 'hidden';  
	imageWrapper.style.visibility = 'hidden'; 
	playlistdiv.style.visibility = 'hidden'; 
	
	if (location.host == "192.168.1.22"){
		currentgun.value = "Gordon";
		othergun.value = "Chell";
	}
	if (location.host == "192.168.1.23"){
		currentgun.value = "Chell";
		othergun.value = "Gordon";
	}
	
	//$('#streamimage').attr("src", 'http://' + location.host + ':8080/?action=stream');
	

	setInterval(function() {
		$.get("/tmp/portal.txt", function (result) {
			var res = result.split(" ");
			if (isNaN(parseFloat(res[29])) == false){
				private_state = parseInt(res[0]);
				shared_state = parseInt(res[1]);
				var connected = parseInt(res[2]);
				var ir_pwm = parseInt(res[3]);

				var changes = 0;
				for (i = 0; i < 10; i++) { 
					var num = parseInt(res[4+i]);
					if (private_playlist[i] != num){
						private_playlist[i] = num;
						changes++;
					}
				}
				if (changes > 0){
					var tempstring = "<u><b>SELF</u></b><br>";
					for (i = 0; i < 10; i++){
						if (private_playlist[i] >= 0){
							tempstring += effect_name(private_playlist[i]) + "<br>"
						}
					}
					selfplaylist.innerHTML = tempstring;
				}
				changes = 0;
				for (i = 0; i < 10; i++) { 
					var num = parseInt(res[16+i]);
					if (shared_playlist[i] != num){
						shared_playlist[i] = num;
						changes++;
					}
				}
				if (changes > 0){
					var tempstring = "<u><b>WIFI</u></b><br>";
					for (i = 0; i < 10; i++){
						if (shared_playlist[i] >= 0){
							tempstring += effect_name(shared_playlist[i]) + "<br>"
						}
					}
					sharedplaylist.innerHTML = tempstring;
				}

				
				var private_effect = parseInt(res[14]);
				var private_playlist_index = parseInt(res[15]);
				var shared_effect = parseInt(res[26]);
				var shared_playlist_index = parseInt(res[27]);
				
				if (private_effect != private_effect_last || private_playlist_index != private_playlist_index_last){
					private_effect_text = effect_name(private_effect) + "<br>" + effect_name(private_playlist[private_playlist_index]);
					private_effect_last = private_effect;
					private_playlist_index_last = private_playlist_index;
				}
				if (shared_effect != shared_effect_last || shared_playlist_index != shared_playlist_index_last){
					shared_effect_text = effect_name(shared_effect) + "<br>" + effect_name(shared_playlist[shared_playlist_index]);
					shared_effect_last = shared_effect;
					shared_playlist_index_last = shared_playlist_index;
				}
				

				var arduino_battery_level = parseFloat(res[28]);
				var arduino_temp = parseFloat(res[29]);
				
				//crap I dont need
				//var arduino_in_pps = parseInt(res[30]);
				//var arduino_out_pps = parseInt(res[31]);
				//var arduino_framing_error = parseInt(res[32]);
				//var arduino_crc_error = parseInt(res[33]);
				//var arduino_cpu_load = parseInt(res[34]);
				
				if(private_state != private_state_last || shared_state != shared_state_last){
					if (private_state == 0 && shared_state == 0){
						portal_text.innerHTML = "";
						portal_background.src = "blank.png";
						portal_foreground.src = "blank.png";
						
						orangewifi.style.backgroundColor = "orange";
						orangewifi.style.color = "black";
						bluewifi.style.backgroundColor = "blue";
						bluewifi.style.color = "white";
						orangeself.style.backgroundColor = "orange";
						orangeself.style.color = "black";
						blueself.style.backgroundColor = "blue";
						blueself.style.color = "white";
						blueself.value = "Self";
						orangeself.value = "Self";
						bluewifi.value = "Wifi";
						orangewifi.value = "Wifi";
					}
					else if (private_state > 0){
						portal_background.src = "orange_0.jpg";
						portal_foreground.src = "orange_portal.png";
						orangewifi.style.backgroundColor = "orange";
						orangewifi.style.color = "transparent";
						bluewifi.style.backgroundColor = "";
						bluewifi.style.color = "transparent";
						if (private_state >= 3){
						blueself.style.backgroundColor = "blue";
						blueself.style.color = "transparent";
						}else{
						blueself.style.backgroundColor = "";
						blueself.style.color = "transparent";
						}
						
						orangeself.style.backgroundColor = "orange";
						orangeself.value = private_state;
						orangeself.style.color = "black";
					}
					else if (private_state < 0){
						portal_background.src = "blue_0.jpg";
						portal_foreground.src = "blue_portal.png";
						orangewifi.style.backgroundColor = "";
						orangewifi.style.color = "transparent";
						bluewifi.style.backgroundColor = "blue";
						bluewifi.style.color = "transparent";
						if (private_state <= -3){
						orangeself.style.backgroundColor = "orange";
						orangeself.style.color = "transparent";
	
						}else{
						orangeself.style.backgroundColor = "";
						orangeself.style.color = "transparent";
						}
						blueself.style.backgroundColor = "blue";
						blueself.value = private_state * -1;
						blueself.style.color = "white";
					}
					else if (shared_state > 0){
						portal_background.src = "orange_0.jpg";
						portal_foreground.src = "orange_portal.png";
						
						bluewifi.style.backgroundColor = "";
						bluewifi.style.color = "transparent";
						orangeself.style.backgroundColor = "orange";
						orangeself.style.color = "transparent";
						
						blueself.style.backgroundColor = "";
						blueself.style.color = "transparent";
						
						orangewifi.style.backgroundColor = "orange";
						orangewifi.value = shared_state;
						orangewifi.style.color = "black";
					}
					else if (shared_state < 0){
						portal_background.src = "blue_0.jpg";
						portal_foreground.src = "blue_portal.png";
						orangewifi.style.backgroundColor = "";
						orangewifi.style.color = "transparent";
						orangeself.style.backgroundColor = "";
						orangeself.style.color = "transparent";
						blueself.style.backgroundColor = "blue";
						blueself.style.color = "transparent";
						bluewifi.style.backgroundColor = "blue";
						bluewifi.value = shared_state * -1;
						bluewifi.style.color = "white";
					}
					mode_set();
					shared_state_last = shared_state;
					private_state_last = private_state;
				}
				
				if (connected != connected_last){
					if (connected == 1 ){
						connectedstate.innerText = "Connected "  + arduino_battery_level + " "+arduino_temp;
					}else{
						connectedstate.innerText = "Disconnected " + arduino_battery_level + " " + arduino_temp;
					}
					connected_last = connected;
				}
			}		
		});
	}, 200);
});

</script>