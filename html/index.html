<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<meta name="viewport" content="initial-scale=1, maximum-scale=1">
<title>Portal Gun 2.0</title>
<link rel="stylesheet" type="text/css" href="portalstyle.css">
</head>
<body id="index-page">
<div class="wrap_div">
<table>
<tr>
<td><div id="gun_name_div"></div></td>
<td>
<select id="menuselecter" onchange="menu(this.value)">
<option value="preview">Home Screen</option>
<option value="load">Load Playlist</option>
<option value="custom">Custom Playlist</option>
<option value="settings">View Settings</option>
<option value="switch">Switch Guns</option>
</select>
</td>
<td><div id="temp_batt_div"></div></td>
</tr>
</table>
<br>
<input type="button" class="button" id="orangewifi" value="0" onclick="submitb(this.id)"/>
<input type="button" class="button" id="orangeself" value="0" onclick="submitb(this.id)"/>
<input type="button" class="button" id="close" value="Close" onclick="submitb(this.id)"/>
<input type="button" class="button" id="blueself" value="0" onclick="submitb(this.id)"/>
<input type="button" class="button" id="bluewifi" value="0" onclick="submitb(this.id)"/>
<br>
<br>
<div class="hidden_div" id="imageWrapper"> 
<br>
<img class="overlayImage1" id="portal_background" src="black.png">
<img class="overlayImage2" id="portal_foreground" src="black.png">
<div class="overlayText" id="portal_text"></div>
</div>
<div class="hidden_div" id="playlist_div"> 
<div id="connected_div"></div>
<br>
<table>
<tr>
<td valign="top"><div id="sharedplaylist"></div></td>
<td valign="top"><div id="selfplaylist"></div></td>
</tr>
</table>
</div>
<div class="hidden_div" id="settings_div"> 
<br>
Nightvision Brightness:
<select id="irselect" onchange="irselect_func(this)">
<option value="256">?</option>
<option value="255">255</option>
<option value="128">128</option>
<option value="64">64</option>
<option value="32">32</option>
<option value="16">16</option>
<option value="0">0</option>
</select>
<br>
<br>
Live Preview:
<select id="livepreview" onchange="livepreview(this)">
<option value="ON">ON</option>
<option value="OFF">OFF</option>
</select>
</div>
<div  class="hidden_div"  id="load_div"> 
<br>
<table>
<tr>
<td align="center" valign="top"><div>
<u><b>WIFI PLAYLISTS</u></b><br>
<input type="button" class="button_text" id="libvisual" onclick="submit(this)" value="vis"/><br>
<input type="button" class="button_text" id="movieclip" onclick="submit(this)" value="clips"/><br>
</div></td>
<td align="center" valign="top"><div>
<u><b>SELF PLAYLISTS</u></b><br>
<input type="button" class="button_text" id="moviemusic" onclick="submit(this)" value="music"/><br>
</div></td>
</tr>
</table>
</div>
<div class="hidden_div"  id="custom_div"> 
Select Item to Edit...<br><br>
<table>
<tr>
<td align="center" valign="top">
<u><b>WIFI PLAYLIST</u></b><br>
<input type="button" class="button_text" id="wifi0" onclick="edit_playlist(0,1)" value=""/><br>
<input type="button" class="button_text" id="wifi1" onclick="edit_playlist(1,1)" value=""/><br>
<input type="button" class="button_text" id="wifi2" onclick="edit_playlist(2,1)" value=""/><br>
<input type="button" class="button_text" id="wifi3" onclick="edit_playlist(3,1)" value=""/><br>
<input type="button" class="button_text" id="wifi4" onclick="edit_playlist(4,1)" value=""/><br>
<input type="button" class="button_text" id="wifi5" onclick="edit_playlist(5,1)" value=""/><br>
<input type="button" class="button_text" id="wifi6" onclick="edit_playlist(6,1)" value=""/><br>
<input type="button" class="button_text" id="wifi7" onclick="edit_playlist(7,1)" value=""/><br>
<input type="button" class="button_text" id="wifi8" onclick="edit_playlist(8,1)" value=""/><br>
<input type="button" class="button_text" id="wifi9" onclick="edit_playlist(9,1)" value=""/><br>
</td>
<td align="center" valign="top">
<u><b>SELF PLAYLIST</u></b><br>
<input type="button" class="button_text" id="self0" onclick="edit_playlist(0,0)" value=""/><br>
<input type="button" class="button_text" id="self1" onclick="edit_playlist(1,0)" value=""/><br>
<input type="button" class="button_text" id="self2" onclick="edit_playlist(2,0)" value=""/><br>
<input type="button" class="button_text" id="self3" onclick="edit_playlist(3,0)" value=""/><br>
<input type="button" class="button_text" id="self4" onclick="edit_playlist(4,0)" value=""/><br>
<input type="button" class="button_text" id="self5" onclick="edit_playlist(5,0)" value=""/><br>
<input type="button" class="button_text" id="self6" onclick="edit_playlist(6,0)" value=""/><br>
<input type="button" class="button_text" id="self7" onclick="edit_playlist(7,0)" value=""/><br>
<input type="button" class="button_text" id="self8" onclick="edit_playlist(8,0)" value=""/><br>
<input type="button" class="button_text" id="self9" onclick="edit_playlist(9,0)" value=""/><br>
</td>
</tr>
</table>
</div>
<div class="hidden_div"  id="edit_div"> 
<input type="button" class="button_text" onclick="save_playlist()" value="Save Changes"/>
<input type="button" class="button_text" onclick="menu('custom')" value="Discard Changes"/><br><br>
<input type="button" onclick="edit_change(-1)" value="<-"/>
<div id="playlist_wifi_div"> 
<select id="playlist_wifi" onchange="update_edit(this)">
<optgroup label="Effects">
<option value="4">4</option>
<option value="19">19</option>
<option value="20">20</option>
<option value="21">21</option>
<option value="22">22</option>
<option value="23">19</option>
<option value="24">24</option>
<option value="25">25</option>
<option value="26">26</option>
<option value="27">27</option>
<option value="28">28</option>
<option value="29">29</option>
<option value="30">30</option>
<option value="31">31</option>
<option value="32">32</option>
<option value="33">33</option>
<option value="34">34</option>
<option value="35">35</option>
<option value="36">36</option>
<option value="37">37</option>
</optgroup> 
<optgroup label="Audio">
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
<option value="13">13</option>
<option value="14">14</option>
<option value="15">15</option>
</optgroup> 
<optgroup label="Test">
<option value="-1">-1</option>
<option value="0">0</option>
<option value="1">1</option>
<option value="2">2</option>
</optgroup> 
<optgroup label="Movies">
<option value="50">50</option>
<option value="51">51</option>
<option value="52">52</option>
<option value="53">53</option>
<option value="54">54</option>
<option value="55">55</option>
<option value="56">56</option>
<option value="57">57</option>
<option value="58">58</option>
<option value="59">59</option>
<option value="60">60</option>
<option value="61">61</option>
</optgroup>
</select>
</div>
<div id="playlist_self_div"> 
<select id="playlist_self" onchange="update_edit(this)">
<optgroup label="Audio">
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
<option value="13">13</option>
<option value="14">14</option>
<option value="15">15</option>
</optgroup> 
<optgroup label="Test">
<option value="-1">-1</option>
<option value="0">0</option>
<option value="1">1</option>
<option value="2">2</option>
</optgroup> 
<optgroup label="Movies">
<option value="50">50</option>
<option value="51">51</option>
<option value="52">52</option>
<option value="53">53</option>
<option value="54">54</option>
<option value="55">55</option>
<option value="56">56</option>
<option value="57">57</option>
<option value="58">58</option>
<option value="59">59</option>
<option value="60">60</option>
<option value="61">61</option>
</optgroup>
</select>
</div>
<input type="button" onclick="edit_change(1)" value="->"/>
<br>
<img id="custom_preview" src="">
</div>
</body>
</html>
<script src="jquery-2.2.0.min.js"></script>
<script>

var last_packet_counter = -1;
var missed_packets = 0;
var requested_mode = "preview";
var connected_last = -1;
var shared_state = -1;
var shared_state_last = -1;
var private_state = -1;
var private_state_last = -1;
var ir_pwm_last = -1;
var private_effect_last = -1;
var private_playlist_index_last = -1;
var shared_effect_last = -1;
var shared_playlist_index_last = -1;

var private_playlist = [0,0,0,0,0,0,0,0,0,0];
var shared_playlist = [0,0,0,0,0,0,0,0,0,0];

var private_effect_text = "";
var shared_effect_text = "";

var arduino_battery_level_last = -1;
var arduino_temp_last = -1;

var edit_num = -11;
var custom_mode = -11;

function update_edit(thing){
	if (thing.value >= 50){
		custom_preview.src = "/assets/" + thing.value.toString() + ".png";
	}else{
		custom_preview.src = "/assets/" + thing.value.toString() + ".gif";
	}
}

function update_custom_buttons(){
	wifi0.value = effect_name(shared_playlist[0]);
	wifi1.value = effect_name(shared_playlist[1]);
	wifi2.value = effect_name(shared_playlist[2]);
	wifi3.value = effect_name(shared_playlist[3]);
	wifi4.value = effect_name(shared_playlist[4]);
	wifi5.value = effect_name(shared_playlist[5]);
	wifi6.value = effect_name(shared_playlist[6]);
	wifi7.value = effect_name(shared_playlist[7]);
	wifi8.value = effect_name(shared_playlist[8]);
	wifi9.value = effect_name(shared_playlist[9]);
	self0.value = effect_name(private_playlist[0]);
	self1.value = effect_name(private_playlist[1]);
	self2.value = effect_name(private_playlist[2]);
	self3.value = effect_name(private_playlist[3]);
	self4.value = effect_name(private_playlist[4]);
	self5.value = effect_name(private_playlist[5]);
	self6.value = effect_name(private_playlist[6]);
	self7.value = effect_name(private_playlist[7]);
	self8.value = effect_name(private_playlist[8]);
	self9.value = effect_name(private_playlist[9]);
}

function reinit_all(){
	
	missed_packets = 0;
	requested_mode = "preview";
	connected_last = -1;
	shared_state = -1;
	shared_state_last = -1;
	private_state = -1;
	private_state_last = -1;
	ir_pwm_last = -1;
	private_effect_last = -1;
	private_playlist_index_last = -1;
	shared_effect_last = -1;
	shared_playlist_index_last = -1;

	private_playlist = [0,0,0,0,0,0,0,0,0,0];
	shared_playlist = [0,0,0,0,0,0,0,0,0,0];

	private_effect_text = "";
	shared_effect_text = "";

	arduino_battery_level_last = -1;
	arduino_temp_last = -1;
	mode_set();
}

function menu(sel){
	if (sel == "switch"){	
		if (location.host == "192.168.1.23"){window.location.href = 'http://192.168.1.22';}
		else if (location.host == "192.168.1.22"){window.location.href = 'http://192.168.1.23';}
	}else{
		requested_mode = sel;
		mode_set();
	}
}

function edit_change(inputnum){
	if (custom_mode == 1){
		var new_index = playlist_wifi.selectedIndex + inputnum;
		if (new_index < 0){ new_index = playlist_wifi.length-1;}
		if (new_index >=  playlist_wifi.length){ new_index = 0;}
		playlist_wifi.selectedIndex = new_index;
		update_edit(playlist_wifi);
	}else if (custom_mode == 0){
		var new_index = playlist_self.selectedIndex + inputnum;
		if (new_index < 0){ new_index = playlist_self.length-1;}
		if (new_index >=  playlist_self.length){ new_index = 0;}
		playlist_self.selectedIndex = new_index;
		update_edit(playlist_self);
	}
}

function edit_playlist( effect_num, mode ){
	playlist_self_div.style.display  = 'none';  
	playlist_wifi_div.style.display  = 'none';  
	if (mode == 0){
		$('#playlist_self').val(private_playlist[effect_num]).change();
		playlist_self_div.style.display  = 'inline'; 
	}else if (mode == 1){
		$('#playlist_wifi').val(shared_playlist[effect_num]).change();
		playlist_wifi_div.style.display  = 'inline'; 
	}
	menu('edit');
	edit_num = effect_num;
	custom_mode = mode;
}

function save_playlist(){
	output = "";
	if (custom_mode == 1){
		for(var i=0; i <10; i++){
			if (edit_num == i){
				output += playlist_wifi.options[playlist_wifi.selectedIndex].value
			}else{
				output += shared_playlist[i];
			}			
			output += " ";
		}
		$.post('index_post.php', {mode: 4, changeto: output});
	}
	else if (custom_mode == 0){
		for(var i=0; i <10; i++){
			if (edit_num == i){
				output += playlist_self.options[playlist_self.selectedIndex].value
			}else{
				output += private_playlist[i];
			}			
			output += " ";
		}
		$.post('index_post.php', {mode: 3, changeto: output});
	}
	menu('custom');
}


function mode_set(){

	if (requested_mode != "edit"){
		menuselecter.value = requested_mode;
	}
	
	edit_div.style.display  = 'none';  
	settings_div.style.display  = 'none';  
	imageWrapper.style.display  = 'none'; 
	playlist_div.style.display  = 'none'; 
	custom_div.style.display  = 'none'; 
	load_div.style.display  = 'none'; 
	
	switch(requested_mode) {
	case "preview":
		if (private_state == 0 && shared_state == 0){ 
			playlist_div.style.display  = 'inline-block'; 
		}else{
			imageWrapper.style.display  = 'inline-block'; 
		}
		break;
	case "settings":
		settings_div.style.display  = 'inline-block'; 
		break;
	case "load":	
		load_div.style.display  = 'inline-block';  
		break;
	case "custom":	
		update_custom_buttons();
		custom_div.style.display  = 'inline-block';  
		break;
	case "edit":	
		edit_div.style.display  = 'inline-block';  
		break;
	}
}

function submitb(button) {
	requested_mode = "preview";
	mode_set();
	var changetoval = 102;//default close
	switch(button) {
	case "orangewifi":
		changetoval = 100;
		break;
	case "orangeself":
		changetoval = 101;
		break;
	case "blueself":
		changetoval = 103;
		break;
	case "bluewifi":
		changetoval = 104;
		break;
	} 
	$.post('index_post.php', {mode: 1,changeto: changetoval});
}

function irselect_func(thing){
	var number = parseInt(thing.value);
	if (number >= 0 && number <= 255){
		$.post('index_post.php', {mode: 2,changeto: number});
	}	
}

function submit(button) {

	if (button.id == 'libvisual'){
		var mode = 3;
		var changeto = "10 13 14 15 -1 -1 -1 -1 -1 -1";
	}
	else if (button.id == 'movieclip'){
		var mode = 3;
		var changeto = "50 51 52 53 54 55 56 57 58 59";
	}
	else if (button.id == 'moviemusic'){
		var mode = 3;
		var changeto = "60 61 -1 -1 -1 -1 -1 -1 -1 -1";
	}		
	
	$.post('index_post.php', {mode: mode,changeto: changeto	});
}

function effect_name(a) {
	switch(a) {
	case -1:	return "RESTART";
	case 0:		return "BLANK";
	case 1:		return "TEST";
	case 2:		return "TEST_CUBE";	
	case 3:		return "RPICAMSRC";	
	case 4:		return "NORMAL";
	case 10:	return "JESS";
	case 11:	return "INFINITE";
	case 12:	return "JACKDAW";
	case 13:	return "OINKSIE";
	case 14:	return "GOOM";
	case 15:	return "GOOM2K1";
	case 19:	return "RADIOACT";
	case 20:	return "REV";
	case 21:	return "AGING";
	case 22:	return "DICE";
	case 23:	return "WARP";
	case 24:	return "SHAGADELIC";
	case 25:	return "VERTIGO";
	case 26:	return "KALEIDOSCOPE";
	case 27:	return "MARBLE";		
	case 28:	return "RIPPLE";
	case 29:	return "EDGE";	
	case 30:	return "GL_CUBE";
	case 31:	return "GL_MIRROR";
	case 32:	return "GL_SQUEEZE";
	case 33:	return "GL_STRETCH";
	case 34:	return "GL_TUNNEL";
	case 35:	return "GL_TWIRL";
	case 36:	return "GL_BULDGE";
	case 37:	return "GLHEAT";		
	case 50:	return "MOVIE1";
	case 51:	return "MOVIE2";
	case 52:	return "MOVIE3";
	case 53:	return "MOVIE4";
	case 54:	return "MOVIE5";
	case 55:	return "MOVIE6";
	case 56:	return "MOVIE7";
	case 57:	return "MOVIE8";		
	case 58:	return "MOVIE9";
	case 59:	return "MOVIE10";
	case 60:	return "MOVIE11";
	case 61:	return "MOVIE12";	
	default:	return "UKNOWN";
	}
}

$(document).ready(function () {

	//populate playlist options
	for(var i=0; i < playlist_self.length; i++){
		playlist_self.options[i].text = effect_name(parseInt(playlist_self.options[i].value));
	}
	for(var i=0; i < playlist_wifi.length; i++){
		playlist_wifi.options[i].text = effect_name(parseInt(playlist_wifi.options[i].value));
	}
	
	menuselecter.value = "preview";
	
	if (location.host == "192.168.1.22"){gun_name_div.innerHTML = "Gordon";}
	else if (location.host == "192.168.1.23"){gun_name_div.innerHTML = "Chell";}
	
	//$('#streamimage').attr("src", 'http://' + location.host + ':8080/?action=stream');
	
	setInterval(update_data, 200);
});

function update_data() {
	$.get("/tmp/portal.txt", function (result) {
		var res = result.split(" ");
		if (missed_packets > 2){reinit_all();}
		var packet_counter = parseInt(res[35]);
		if (isNaN(packet_counter) == true){
			missed_packets++;
		}else{
			last_packet_counter = packet_counter;
			missed_packets = 0;
			
			private_state = parseInt(res[0]);
			shared_state = parseInt(res[1]);
			
			var ir_pwm = parseInt(res[3]);
			if (ir_pwm_last != ir_pwm){
				//top option is current setting
				irselect.options[0].text = ir_pwm;
				irselect.value = "256";
				ir_pwm_last= ir_pwm;
			}
			
			var connected = parseInt(res[2]);
			if (connected != connected_last){
				if (connected == 1 ){
					connected_div.innerHTML = "Guns are Connected";
				}else{
					connected_div.innerHTML = "Other Gun is Disconnected";
				}
				connected_last = connected;
			}
			
			var changes = 0;
			for (i = 0; i < 10; i++) { 
				var num = parseInt(res[4+i]);
				if (private_playlist[i] != num){
					private_playlist[i] = num;
					changes++;
				}
			}
			if (changes > 0){
				var tempstring = "<u><b>SELF PLAYLIST</u></b><br>";
				for (i = 0; i < 10; i++){
					if (private_playlist[i] >= 0){
						tempstring += effect_name(private_playlist[i]) + "<br>"
					}
				}
				selfplaylist.innerHTML = tempstring;
			}
			
			var changes2 = 0;
			for (i = 0; i < 10; i++) { 
				var num = parseInt(res[16+i]);
				if (shared_playlist[i] != num){
					shared_playlist[i] = num;
					changes2++;
				}
			}
			if (changes2 > 0){
				var tempstring = "<u><b>WIFI PLAYLIST</u></b><br>";
				for (i = 0; i < 10; i++){
					if (shared_playlist[i] >= 0){
						tempstring += effect_name(shared_playlist[i]) + "<br>"
					}
				}
				sharedplaylist.innerHTML = tempstring;
			}
			
			//dont bother updating buttons if we are not displaying them
			if ((changes != 0 || changes2 != 0) && requested_mode == "custom" ){
				update_custom_buttons();
			}
			
			var private_effect = parseInt(res[14]);
			var private_playlist_index = parseInt(res[15]);
			var shared_effect = parseInt(res[26]);
			var shared_playlist_index = parseInt(res[27]);
			
			if (private_effect != private_effect_last || private_playlist_index != private_playlist_index_last){
				private_effect_text = effect_name(private_effect) + "<br>" + effect_name(private_playlist[private_playlist_index]);
				private_effect_last = private_effect;
				private_playlist_index_last = private_playlist_index;
			}
			if (shared_effect != shared_effect_last || shared_playlist_index != shared_playlist_index_last){
				shared_effect_text = effect_name(shared_effect) + "<br>" + effect_name(shared_playlist[shared_playlist_index]);
				shared_effect_last = shared_effect;
				shared_playlist_index_last = shared_playlist_index;
			}
			

			var arduino_battery_level = parseFloat(res[28]);
			var arduino_temp = parseFloat(res[29]);
			
			if ((arduino_battery_level != arduino_battery_level_last) || (arduino_temp != arduino_temp_last)){
				temp_batt_div.innerText = arduino_battery_level + " V  " + arduino_temp + " F";
				arduino_battery_level_last = arduino_battery_level;
				arduino_temp_last = arduino_temp;
			}
			//crap I dont need
			//var arduino_in_pps = parseInt(res[30]);
			//var arduino_out_pps = parseInt(res[31]);
			//var arduino_framing_error = parseInt(res[32]);
			//var arduino_crc_error = parseInt(res[33]);
			//var arduino_cpu_load = parseInt(res[34]);
			
			if(private_state != private_state_last || shared_state != shared_state_last){
				if (private_state == 0 && shared_state == 0){
					portal_text.innerHTML = "";
					portal_background.src = "blank.png";
					portal_foreground.src = "blank.png";
					
					orangewifi.style.backgroundColor = "orange";
					orangewifi.style.color = "black";
					bluewifi.style.backgroundColor = "blue";
					bluewifi.style.color = "white";
					orangeself.style.backgroundColor = "orange";
					orangeself.style.color = "black";
					blueself.style.backgroundColor = "blue";
					blueself.style.color = "white";
					blueself.value = "Self";
					orangeself.value = "Self";
					bluewifi.value = "Wifi";
					orangewifi.value = "Wifi";
				}
				else if (private_state > 0){
					portal_background.src = "orange_0.jpg";
					portal_foreground.src = "orange_portal.png";
					orangewifi.style.backgroundColor = "orange";
					orangewifi.style.color = "transparent";
					bluewifi.style.backgroundColor = "";
					bluewifi.style.color = "transparent";
					if (private_state >= 3){
						blueself.style.backgroundColor = "blue";
						blueself.style.color = "transparent";
					}else{
						blueself.style.backgroundColor = "";
						blueself.style.color = "transparent";
					}
					
					orangeself.style.backgroundColor = "orange";
					orangeself.value = private_state;
					orangeself.style.color = "black";
				}
				else if (private_state < 0){
					portal_background.src = "blue_0.jpg";
					portal_foreground.src = "blue_portal.png";
					orangewifi.style.backgroundColor = "";
					orangewifi.style.color = "transparent";
					bluewifi.style.backgroundColor = "blue";
					bluewifi.style.color = "transparent";
					if (private_state <= -3){
						orangeself.style.backgroundColor = "orange";
						orangeself.style.color = "transparent";
						
					}else{
						orangeself.style.backgroundColor = "";
						orangeself.style.color = "transparent";
					}
					blueself.style.backgroundColor = "blue";
					blueself.value = private_state * -1;
					blueself.style.color = "white";
				}
				else if (shared_state > 0){
					portal_background.src = "orange_0.jpg";
					portal_foreground.src = "orange_portal.png";
					
					bluewifi.style.backgroundColor = "";
					bluewifi.style.color = "transparent";
					orangeself.style.backgroundColor = "orange";
					orangeself.style.color = "transparent";
					
					blueself.style.backgroundColor = "";
					blueself.style.color = "transparent";
					
					orangewifi.style.backgroundColor = "orange";
					orangewifi.value = shared_state;
					orangewifi.style.color = "black";
				}
				else if (shared_state < 0){
					portal_background.src = "http://" + location.host + ":8080/?action=stream";
					portal_foreground.src = "blue_portal.png";
					orangewifi.style.backgroundColor = "";
					orangewifi.style.color = "transparent";
					orangeself.style.backgroundColor = "";
					orangeself.style.color = "transparent";
					blueself.style.backgroundColor = "blue";
					blueself.style.color = "transparent";
					bluewifi.style.backgroundColor = "blue";
					bluewifi.value = shared_state * -1;
					bluewifi.style.color = "white";
				}
				mode_set();
				shared_state_last = shared_state;
				private_state_last = private_state;
			}
			
			
		}		
	});
}
</script>